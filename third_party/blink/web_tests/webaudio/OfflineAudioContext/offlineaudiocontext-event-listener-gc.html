<!DOCTYPE html>
<script src="../../resources/testharness.js"></script>
<script src="../../resources/testharnessreport.js"></script>
<script>
const sampleRate = 48000;
const renderSeconds = 1;
const renderFrames = sampleRate * renderSeconds;
const contextChannels = 2;

// Event listeners should not be garbage-collected prematurely.
// The test passes if it does not time out waiting for oncomplete.
promise_test(async t => {
  const context =
      new OfflineAudioContext(contextChannels, renderFrames, sampleRate);

  const buffer = new AudioBuffer({
    numberOfChannels: contextChannels,
    length: renderFrames,
    sampleRate: sampleRate
  });
  buffer.getChannelData(0).fill(1);
  buffer.getChannelData(1).fill(2);

  const source = new AudioBufferSourceNode(context, { buffer });
  source.connect(context.destination);
  source.start();

  const onCompletePromise = new Promise(resolve => {
     context.oncomplete = () => {
       resolve();
     };
   });

  // Run a full GC. This should not collect the event listener.
  if (window.GCController) {
    window.GCController.collectAll();
  }

  await context.startRendering();
  await onCompletePromise;
}, 'event-listener-gc');
</script>
