// Copyright 2025 The Chromium Authors
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

#ifndef CHROME_BROWSER_AUTOFILL_GLIC_ACTOR_FORM_FILLING_SERVICE_IMPL_H_
#define CHROME_BROWSER_AUTOFILL_GLIC_ACTOR_FORM_FILLING_SERVICE_IMPL_H_

#include <cstdint>
#include <variant>
#include <vector>

#include "base/containers/flat_map.h"
#include "chrome/browser/autofill/glic/actor_form_filling_service.h"
#include "components/autofill/core/browser/data_model/addresses/autofill_profile.h"
#include "components/autofill/core/browser/data_model/payments/credit_card.h"

namespace tabs {
class TabInterface;
}

namespace autofill {

// Implementation of the Actor -> Autofill interface, which is owned by
// `actor::ExecutionEngine`. Keeps the state generated by `GetSuggestions()`
// so that subsequent filling can refer to it by ID.
class ActorFormFillingServiceImpl : public ActorFormFillingService {
 public:
  ActorFormFillingServiceImpl();
  ActorFormFillingServiceImpl(const ActorFormFillingServiceImpl&) = delete;
  ActorFormFillingServiceImpl& operator=(const ActorFormFillingServiceImpl&) =
      delete;
  ActorFormFillingServiceImpl(ActorFormFillingServiceImpl&&) = delete;
  ActorFormFillingServiceImpl& operator=(ActorFormFillingServiceImpl&&) =
      delete;
  ~ActorFormFillingServiceImpl() override;

  // ActorFormFillingService:
  void GetSuggestions(
      const tabs::TabInterface& tab,
      base::span<const FillRequest> fill_requests,
      base::OnceCallback<
          void(base::expected<std::vector<ActorFormFillingRequest>,
                              ActorFormFillingError>)> callback) override;
  void FillSuggestions(
      const tabs::TabInterface& tab,
      base::span<const ActorFormFillingSelection> chosen_suggestions,
      base::OnceCallback<void(base::expected<void, ActorFormFillingError>)>
          callback) override;

  // A record to keep track of the data that is backing an `ActorSuggestion`.
  struct FillData final {
    using Payload = std::variant<std::monostate, AutofillProfile, CreditCard>;

    FillData();
    FillData(std::vector<FieldGlobalId> field_ids, Payload filling_payload);
    FillData(const FillData&);
    FillData& operator=(const FillData&);
    FillData(FillData&&);
    FillData& operator=(FillData&&);
    ~FillData();

    // Returns whether the payload corresponds to a payments instrument.
    bool HasPaymentsPayload() const;

    // Fields that represents the form sections that are supposed to be filled.
    std::vector<FieldGlobalId> field_ids;
    Payload filling_payload;
  };

 private:
  // A running counter used to generate `ActorSuggestionId`s.
  ActorSuggestionId::Generator suggestion_id_generator_;

  // A map from actor suggestions generated by `this` to the data required
  // for performing the form fill.
  base::flat_map<ActorSuggestionId, FillData> fill_data_;
};

}  // namespace autofill

#endif  // CHROME_BROWSER_AUTOFILL_GLIC_ACTOR_FORM_FILLING_SERVICE_IMPL_H_
