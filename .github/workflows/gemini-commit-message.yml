name: 'Gemini Commit Message Generator'

on:
  pull_request:
    types: [opened, reopened]
  issue_comment:
    types: [created]

env:
  PROMPT: |
    Act as an expert software engineer specializing in the Cobalt codebase, which
    is a fork of Chromium. Your task is to generate a professional and
    informative Git commit message based on the provided pull request details.
    The final output should be only the commit message itself, without any extra
    conversational text or markdown formatting. Do not use backticks (`) in your
    response.

    You must strictly adhere to the following rules:

    **Commit Message Structure:**

    1.  **Tag Prefix:** The subject line MUST be prefixed with a tag followed by
        a colon (e.g., "media: Add support for AV1"). Prefer component tags over
        type tags.
    2.  **Subject:** Capitalize the subject line, use the imperative mood, limit
        it to 50 characters, and do not end it with a period.
    3.  **Body:** Separate the subject from the body with a blank line. The body
        should explain the 'what' and 'why' of the change, not the 'how', and
        wrap at 72 characters.
    4.  **Bug Trailer:** Add a 'Bug: xyz' git trailer on the last line.

    **Tag Selection (Prefix the subject line with one of these):**

    * **Component Tags (Preferred):**
        * `android`: Android-specific changes.
        * `tvos`: tvOS-specific changes.
        * `build`: Changes to the build system (GN files, build scripts).
        * `cobalt`: Changes specific to the Cobalt browser logic.
        * `evergreen`: For Evergreen-specific changes.
        * `linux`: Linux-specific changes.
        * `media`: Changes related to the media pipeline (player, demuxer,
          etc.).
        * `net`: For networking changes (e.g., QUIC, sockets).
        * `posix`: POSIX-related changes.
        * `starboard`: Changes to the Starboard abstraction layer.
    * **Type Tags (Use if no component tag applies):**
        * `ci`: Changes to CI/CD workflows.
        * `cleanup`: Code cleanup (e.g., removing unused code, style fixes).
        * `docs`: Documentation updates.
        * `feat`: A new feature.
        * `fix`: A bug fix.
        * `refactor`: Code refactoring without changing functionality.
        * `revert`: Reverting a previous commit.
        * `test`: For changes to tests (e.g., nplb, unit tests).

    Given your expertise with Cobalt/Chromium, infer the context of the changes
    to select the most relevant tag.

    **Analyze the following pull request information and generate the commit
    message:**

jobs:
  generate_commit_message:
    # Run condition: PR open/reopen OR comment '/generate-commit-message' on a PR
    if: >
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.comment.body == '/generate-commit-message')

    runs-on: ubuntu-latest

    permissions:
      issues: write
      pull-requests: write

    steps:
      # --- Step 1: Get PR Diff ---
      - name: 'Get PR Diff'
        id: diff
        run: |
          set -eux
          # Logic: Concatenate both URLs. Since events are exclusive, one will be empty.
          # PR Event URL + Issue Comment URL
          PR_API_URL="${{ github.event.pull_request.url }}${{ github.event.issue.pull_request.url }}"

          diff_content=$(curl -fsSL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github.v3.diff" "$PR_API_URL")

          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          echo "$diff_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --- Step 2: Call Gemini API ---
      - name: 'Generate Commit Message with Gemini'
        id: gemini
        # Security: Load untrusted data into ENV variables safely.
        # We use concatenation ${{ A }}${{ B }} instead of || to avoid parser errors.
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}${{ github.event.issue.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}${{ github.event.issue.title }}
          PR_BODY: ${{ github.event.pull_request.body }}${{ github.event.issue.body }}
          PR_DIFF: ${{ steps.diff.outputs.diff_content }}
          GEMINI_SECRET: ${{ secrets.GEMINI_ACTIONS_API_KEY }}
        run: |
          set -eux

          # Use jq to safely combine the instructions with the variables
          json_payload=$(jq -n \
            --arg instr "$PROMPT" \
            --arg url "$PR_URL" \
            --arg title "$PR_TITLE" \
            --arg body "$PR_BODY" \
            --arg diff "$PR_DIFF" \
            '{
              contents: [{
                parts: [{
                  text: ($instr + "\n\n**Pull Request URL:** " + $url + "\n**Pull Request Title:** " + $title + "\n**Original PR Description:**\n" + $body + "\n\n**Code Diff to Analyze:**\n" + $diff)
                }]
              }]
            }')

          api_response=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_SECRET" \
            -H "Content-Type: application/json" \
            -d "$json_payload")

          gemini_text_response=$(echo "$api_response" | jq -r '.candidates[0].content.parts[0].text // "Error: Could not parse a valid response from the Gemini API. Please check the API response logs in the workflow run."')

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$gemini_text_response" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --- Step 3: Post Comment ---
      - name: 'Post Commit Message as Comment'
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: |
            ### ðŸ¤– Gemini Suggested Commit Message

            ---

            ```
            ${{ steps.gemini.outputs.response }}
            ```

            ---

            **ðŸ’¡ Pro Tips for a Better Commit Message:**

            1.  **Influence the Result:** Want to change the output? You can write **custom prompts or instructions** directly in the **Pull Request description**. The model uses that text to generate the message.
            2.  **Re-run the Generator:** Post a comment with: `/generate-commit-message`
        with:
          script: |
            const body = process.env.COMMENT_BODY;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              // Logic: Concatenate numbers. One will be empty, leaving the correct ID.
              issue_number: ${{ github.event.pull_request.number }}${{ github.event.issue.number }},
              body: body
            });
