<html>
  <head>
    <style>
      body {
        margin: 0;
        background: #0d0d0d;
      }
      video {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <video class="video" id="video" muted disableRemotePlayback></video>
    <div class="placeholder" id="placeholder"></div>
  </body>
  <footer>
    <script>
      function objectUrlFromSafeSource(source) {
        return URL.createObjectURL(source);
      }

      const maybeDestroyVideoInstance = () => {};
      const getPlaceholderEl = () => document.getElementById('placeholder');
      const getVideoEl = () => document.getElementById('video');

      function animate(onAnimationEnd) {
        const videoEl = getVideoEl();
        if (!videoEl) {
          return;
        }

        videoEl.addEventListener('ended', () => {
          maybeDestroyVideoInstance();
          onAnimationEnd && onAnimationEnd();
          window.close();
        });

        const showPlaceholderImage = () => {
          const placeholderEl = getPlaceholderEl && getPlaceholderEl();
          if (placeholderEl) {
            placeholderEl.style.opacity = '100%';
          }
        };
        playSplashAnimation(/*afterVideoStart=*/ showPlaceholderImage);
      }

      /**
       * Plays the splash animation video in the given video element.
       * @param afterVideoStart Callback function when the video starts playing.
       */
      function playSplashAnimation(afterVideoStart) {
        const videoEl = getVideoEl();
        if (!videoEl) {
          return;
        }
        const mediaSource = new MediaSource();
        mediaSource.addEventListener('sourceopen', () => {
          const sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp9"');
          // Get cache from the html itself's URL parameter.
          // TODO(463395742): Set the fallback suffix depending on the device spec.
          const params = new URLSearchParams(window.location.search);
          if (!params.has('cache')) {
            params.append('cache', 'default');
          }
          fetch('h5vcc-embedded://splash.webm?' + params.toString())
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.arrayBuffer();
            })
            .then(data => {
              sourceBuffer.addEventListener('updateend', () => {
                if (!sourceBuffer.updating && mediaSource.readyState === 'open') {
                  mediaSource.endOfStream();
                  videoEl.play();
                  afterVideoStart && afterVideoStart();
                }
              });
              sourceBuffer.appendBuffer(data);
            })
            .catch(error => {
              console.error('Failed to fetch splash video:', error);
            });
        });

        videoEl.src = objectUrlFromSafeSource(mediaSource).toString();
      }

      animate(() => console.log('splash animation completed!'));
    </script>
  </footer>
</html>
