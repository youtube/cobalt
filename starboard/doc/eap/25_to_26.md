# Migrating a platform

We use RDK as our reference platform, and performed the migration from Cobalt 25 to Cobalt 26 support for it as one of the first platforms. You can find the vast majority of the changes we needed the make in the following changes:
* https://cobalt.googlesource.com/external/components/generic/cobalt/+/d7236a995f023bba1c74ad95602f460c2fa72297.

## Overview

Below are the high level steps for what is needed when migrating a platform:
* Add your platform to `_COBALT_STARBOARD_PLATFORMS` in `cobalt/build/gn.py` and add an `args.gn` file for your platform at `cobalt/build/configs/<platform_name>/args.gn`.
  * Ensure you set the following variables:
    ```
    import("//cobalt/build/configs/linux-x64x11-modular/args.gn")
    target_os =
    target_cpu =
    use_evergreen = true
    starboard_path =
    ```
    Using the appropriate OS and CPU for your target platform and setting the starboard path to the directory containing your port (i.e. the starboard_path for the linux-x64x11 reference platform is `starboard/linux/x64x11`).
* Must update Starboard functions (this will mostly just involve getting rid of deprecated functions, see [starboard/CHANGELOG.md](../../../starboard/CHANGELOG.md), but you may need to modify wrappers under `//starboard/shared/modular/` if NPLB test fail).
* Some Chromium settings may cause issues. If you run into any of these issues, please contact the Cobalt team so we can make the changes upstream.
* Validate with NPLB test suite and by running Cobalt.
* Validate with running YTS. Ideally aim for parity with C25 results

## Building and Running

To build Cobalt and NPLB:
```
python cobalt/build/gn.py -p <your_platform> -c <config> --no-rbe
autoninja -C out/<your_platform>_<config>/ cobalt_loader nplb_loader
```

To run Cobalt:
```
out/<your_platform>_<config>/loader_app
```

Or, if you need to deploy to a device, i.e. to run NPLB:
```
tar czpf nplb.tgz -C out/<your_platform>_<config>/ -T out/<your_platform>_<config>/nplb_loader.runtime_deps

# Copy to your device

tar xzpf nplb.tgz
./nplb_loader.py
```

Note that the helper python script simply runs `elf_loader_sandbox --evergreen_content=. --evergreen_libary=libnplb.so`, which you do manually instead if you prefer, changing the flag values as necessary.
