<!DOCTYPE html>
<html class="reftest-wait">
  <title>WebGPU copyElementImageToTexture with scaling</title>
  <meta charset="utf-8" />
  <link rel="help" href="https://github.com/WICG/html-in-canvas" />
  <link rel="match" href="copy_element_image_to_texture-scaled-ref.html" />
  <link rel="stylesheet" href="/wpt_internal/resources/canvas-draw-element/styles.css" />
  <script src="/wpt_internal/resources/canvas-draw-element/color-grid.js"></script>
  <script src="/common/reftest-wait.js"></script>

  <style>
   body {
     display: grid;
     grid: 256px / 1fr 1fr 1fr;
     align-items: start;
   }
   canvas {
     width: 256px;
     height: 256px;
   }
   color-grid {
     width: 100px;
     height: 100px;
   }
  </style>

  <canvas layoutsubtree>
    <div class="draw-element-wrapper">
      <div class="css-is-awesome"></div>
    </div>
  </canvas>

  <canvas layoutsubtree>
    <div class="draw-element-wrapper">
      <color-grid></color-grid>
    </div>
  </canvas>

  <canvas layoutsubtree>
    <div class="draw-element-wrapper" xscale="0.5" yscale="0.5">
      <color-grid></color-grid>
    </div>
  </canvas>

  <canvas layoutsubtree>
    <div class="draw-element-wrapper" xscale="2" yscale="2">
      <color-grid></color-grid>
    </div>
  </canvas>

  <canvas layoutsubtree>
    <div class="draw-element-wrapper" xscale="2" yscale="0.5">
      <color-grid></color-grid>
    </div>
  </canvas>

<script type="module">
import { resizeToPixelGrid, copyElementImageToWebGPUCanvas } from "/wpt_internal/resources/canvas-draw-element/util.js";

const adapter = await navigator.gpu.requestAdapter();
const device = await adapter.requestDevice();
const queue = device.queue;

Promise.all(Array.from(document.querySelectorAll("canvas")).map(async cvs => {
  await resizeToPixelGrid(cvs);
  const ctx = cvs.getContext("webgpu");
  ctx.configure({
    device: device,
    format: navigator.gpu.getPreferredCanvasFormat(),
    usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,
    alphaMode: "premultiplied",
  });
  const target = cvs.firstElementChild;
  if (target.hasAttribute("xscale") && target.hasAttribute("yscale")) {
    const scaleX = Number.parseFloat(target.getAttribute("xscale"));
    const scaleY = Number.parseFloat(target.getAttribute("yscale"));
    copyElementImageToWebGPUCanvas(queue, ctx, target, scaleX, scaleY);
  } else {
    copyElementImageToWebGPUCanvas(queue, ctx, target);
  }
})).then(takeScreenshot);
</script>
</html>
