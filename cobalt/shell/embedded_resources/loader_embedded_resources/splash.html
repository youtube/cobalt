<html>
  <head>
    <style>
      body {
        margin: 0;
        background: #0d0d0d;
      }
      video {
        height: 100%;
        width: 100%;
      }
      .placeholder {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-size: cover;
        background-position: center;
        opacity: 0;
      }
    </style>
  </head>
  <body>
    <video class="video" id="video" muted disableRemotePlayback></video>
    <div class="placeholder" id="placeholder"></div>
  </body>
  <footer>
    <script>
      function objectUrlFromSafeSource(source) {
        return URL.createObjectURL(source);
      }

      const maybeDestroyVideoInstance = () => {};
      const getPlaceholderEl = () => document.getElementById('placeholder');
      const getVideoEl = () => document.getElementById('video');

      function animate(onAnimationEnd) {
        const videoEl = getVideoEl();
        if (!videoEl) {
          return;
        }

        const onSplashEnd = () => {
          onAnimationEnd && onAnimationEnd();
          window.close();
        }

        videoEl.addEventListener('ended', () => {
          maybeDestroyVideoInstance();
          onSplashEnd();
        });

        const showPlaceholderImage = () => {
          const placeholderEl = getPlaceholderEl && getPlaceholderEl();
          if (placeholderEl) {
            placeholderEl.style.opacity = '100%';
          }
        };
        playSplashAnimation(/*afterVideoStart=*/ showPlaceholderImage, onSplashEnd);
      }

      /**
       * Displays static splash screen for devices that don't support VP9
       */
      function handleStaticImageFallback(urlParams, afterImageLoad) {
        const placeholderEl = getPlaceholderEl();
        if (!placeholderEl) {
          return;
        }

        fetch('h5vcc-embedded://splash.png?' + urlParams.toString())
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.blob();
        })
        .then(imageBlob => {
          const imageUrl = URL.createObjectURL(imageBlob);
          placeholderEl.style.backgroundImage = `url(${imageUrl})`;
          placeholderEl.style.opacity = '100%';
          afterImageLoad && afterImageLoad(); 
          // need timeout?
          // setTimeout(() => {
          //   afterImageLoad && afterImageLoad();
          // }, 1500);
        })
        .catch(error => {
          console.error('Failed to fetch splash image:', error);
        });
        return;
      }

      /**
       * Plays the splash video based on resolution the device supports
       */
      function handleVideo(urlParams, afterVideoStart) {
        const videoEl = getVideoEl();
        if (!videoEl) {
          return;
        }
        const mediaSource = new MediaSource();
        mediaSource.addEventListener('sourceopen', async () => {
          const sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp9"');
          // The default splash video is splash.webm. If it does not exist in
          // the given cache, "fallback" parameter specifies which built-in video
          // to use.
          if (!MediaSource.isTypeSupported("video/webm; codecs=\"vp9\"; width=3840; height=2160;")) {
            urlParams.append('fallback', 'splash_480.webm');
          }
          try {
            const response = await fetch(
                'h5vcc-embedded://splash.webm?' + urlParams.toString());
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            const data = await response.arrayBuffer();
            sourceBuffer.addEventListener('updateend', () => {
              if (!sourceBuffer.updating && mediaSource.readyState === 'open') {
                mediaSource.endOfStream();
                videoEl.play();
                afterVideoStart && afterVideoStart();
              }
            }, {once: true});
            sourceBuffer.appendBuffer(data);
          } catch (error) {
            console.error('Failed to fetch splash video:', error);
          }
        }, {once: true});
        videoEl.src = objectUrlFromSafeSource(mediaSource).toString();
      }

      /**
       * Plays the splash animation depending on device type.
       * @param afterVideoStart Callback function when the video starts playing.
       * @param afterImageLoad Callback function for static image.
       */
      function playSplashAnimation(afterVideoStart, afterImageLoad) {
        const params = new URLSearchParams(window.location.search);
        if (!params.has('cache')) {
          params.append('cache', 'default');
        }
        
        // device does not support VP9, fallback to display static image 
        if (!MediaSource.isTypeSupported("video/webm; codecs=\"vp9\";")) {
          return handleStaticImageFallback(params, afterImageLoad);
        }

        return handleVideo(params, afterVideoStart);
      }

      animate(() => console.log('splash animation completed!'));
    </script>
  </footer>
</html>
