Name: libdmg-hfsplus
Short Name: libdmg-hfsplus
URL: https://github.com/mozilla/libdmg-hfsplus
Version: N/A
Revision: dd3db70c0f36927471cd3582f3ab0c637b5f8e59
Update Mechanism: Manual (https://crbug.com/461840788)
License: GPL-3.0
License File: src/LICENSE
CPEPrefix: unknown
Security Critical: no
Shipped: no

Description:
libdmg-hfsplus is a POSIX-compatible OSS library and toolchain for authoring
and modifying a limited subset of Apple DMG files containing HFS+ filesystems.
This library is part of packaging Chrome into DMGs for distribution, offering
much more control over the generated DMG than Apple's tools provide. See
crbug.com/404856000 for more details on the project to convert Chrome's Mac
packaging process to use this library. There are many divergent forks of this
project; this specific upstream is the fork maintained by Mozilla, used for
packaging Firefox.

Most importantly for Chrome distribution, libdmg-hfsplus can generate a DMG
file that can be efficiently patched with brand codes (or other attribution
strings) without fully decompressing the DMG or fully parsing its structure
and contained file system. This uses Apple's documented mechanism for
customizing individual application instances without breaking code
signing or notarization; see
https://developer.apple.com/library/archive/technotes/tn2206/_index.html#//apple_ref/doc/uid/DTS40007919-CH1-TNTAG401
for more details (section "Moving Away From Custom Resource Rules").

This codebase must not be used anywhere it will be exposed to untrusted inputs.
It is written in plain C with minimal input sanitization, missing bounds checks,
incorrect memory management, inconsistent error handling, and heavy reliance on
illegal pointer casts for a variety of purposes (both field repurposing and type
punning show up). Mozilla has added a modest suite
of functional tests covering the functionality they added, touching on base
functionality of the library along the way, but these tests rely on bit-for-bit
reproducible output; due to platform differences in compression libraries, they
are effectively nonportable.

As such, the Chrome build process isolates it to the greatest extent possible,
running it on its own VM with limited capabilities and access only to the files
it needs to package, and a means of output. The DMGs created by this tool are
not signed, since the VM does not have signing authority and they are intended
to be patched dynamically for brand code assignment. macOS does not block
unsigned DMGs, and code signing for the contained application is preserved,
since the "patch region" for brand codes is contained in the extended attribute
documented in the Apple tech note link above.

The security posture of the project makes it an odd choice for Chromium, but
no other DMG authoring library is known; all tools not derived from this
codebase appear to rely on Apple's DMG authoring utility, `hdiutil`, instead.
`hdiutil` cannot reliably package Chromium with any extended attribute attached,
before any consideration about patching it without rebuilding the entire DMG;
after extensive experimentation, the only mode capable of packaging Chromium
with its current size and complexity (c.a. late 2025) is the mode that does
not support HFS+ extended attributes at all.

This target cannot be made to build in Chromium without modification due to
some `#define` conflicts from Chromium's zlib. To support all features required
for creating Chromium DMGs, symlink behavior must change (to copy symlinks
as symlinks, rather than duplicating their contents) and a new HFS+ volume
configuration feature must be added (setting a folder to be automatically
opened on mount).

Local modifications: None
