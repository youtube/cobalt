<html>
  <head>
    <style>
      body {
        margin: 0;
        background: #0d0d0d;
      }
      video {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <video class="video" id="video" muted disableRemotePlayback></video>
    <div class="placeholder" id="placeholder"></div>
  </body>
  <footer>
    <script>
      function objectUrlFromSafeSource(source) {
        return URL.createObjectURL(source);
      }

      const maybeDestroyVideoInstance = () => {};
      const getPlaceholderEl = () => document.getElementById('placeholder');
      const getVideoEl = () => document.getElementById('video');

      function animate(onAnimationEnd) {
        const videoEl = getVideoEl();
        if (!videoEl) {
          return;
        }

        videoEl.addEventListener('ended', () => {
          maybeDestroyVideoInstance();
          onAnimationEnd && onAnimationEnd();
          window.close();
        });

        const showPlaceholderImage = () => {
          const placeholderEl = getPlaceholderEl && getPlaceholderEl();
          if (placeholderEl) {
            placeholderEl.style.opacity = '100%';
          }
        };
        playSplashAnimation(/*afterVideoStart=*/ showPlaceholderImage);
      }

      /**
       * Plays the splash animation video in the given video element.
       * @param afterVideoStart Callback function when the video starts playing.
       */
      function playSplashAnimation(afterVideoStart) {
        const videoEl = getVideoEl();
        if (!videoEl) {
          return;
        }
        const mediaSource = new MediaSource();
        mediaSource.addEventListener('sourceopen', async () => {
          const sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp9"');
          const params = new URLSearchParams(window.location.search);
          if (!params.has('cache')) {
            params.append('cache', 'default');
          }
          // TODO(458074360): fallback to static image if the device does not support VP9.
          if (!MediaSource.isTypeSupported("video/webm; codecs=\"vp9\"; width=3840; height=2160;")) {
            params.append('fallback', 'splash_480.webm');
          }
          // The default splash video is splash.webm. If it does not exist in
          // the given cache, "fallback" parameter specifies which built-in video
          // to use.
          try {
            const response = await fetch(
                'h5vcc-embedded://splash.webm?' + params.toString());
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            const data = await response.arrayBuffer();
            sourceBuffer.addEventListener('updateend', () => {
              if (!sourceBuffer.updating && mediaSource.readyState === 'open') {
                mediaSource.endOfStream();
                videoEl.play();
                afterVideoStart && afterVideoStart();
              }
            }, {once: true});
            sourceBuffer.appendBuffer(data);
          } catch (error) {
            console.error('Failed to fetch splash video:', error);
          }
        }, {once: true});

        videoEl.src = objectUrlFromSafeSource(mediaSource).toString();
      }

      animate(() => console.log('splash animation completed!'));
    </script>
  </footer>
</html>
